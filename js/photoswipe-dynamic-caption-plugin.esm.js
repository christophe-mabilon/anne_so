let defaultOptions={captionContent:".pswp-caption-content",type:"auto",horizontalEdgeThreshold:20,mobileCaptionOverlapRatio:.3,mobileLayoutBreakpoint:600,verticallyCenterImage:!1};class PhotoSwipeDynamicCaption{constructor(e,i){this.options={...defaultOptions,...i},this.lightbox=e,this.lightbox.on("init",()=>{this.pswp=this.lightbox.pswp,this.initCaption()})}initCaption(){let{pswp:e}=this;e.on("change",()=>{this.showCaption(this.pswp.currSlide)}),e.on("calcSlideSize",e=>this.onCalcSlideSize(e)),e.on("slideDestroy",e=>{e.slide.dynamicCaption&&(e.slide.dynamicCaption.element&&e.slide.dynamicCaption.element.remove(),delete e.slide.dynamicCaption)}),e.on("zoomPanUpdate",({slide:i})=>{if(e.opener.isOpen&&i.dynamicCaption){if(i.currZoomLevel>i.zoomLevels.initial?this.hideCaption(i):this.showCaption(i),i.dynamicCaption.element){let t=0;if(i.currZoomLevel<=i.zoomLevels.initial){let n=i.pan.y-i.bounds.center.y;Math.abs(n)>1&&(t=n)}this.setCaptionYOffset(i.dynamicCaption.element,t)}this.adjustPanArea(i,i.currZoomLevel)}}),e.on("beforeZoomTo",i=>{this.adjustPanArea(e.currSlide,i.destZoomLevel)}),e.on("tapAction",e=>{e.originalEvent.target.closest(".pswp__dynamic-caption")&&e.preventDefault()})}adjustPanArea(e,i){e.dynamicCaption&&e.dynamicCaption.adjustedPanAreaSize&&(i>e.zoomLevels.initial?(e.panAreaSize.x=e.dynamicCaption.originalPanAreaSize.x,e.panAreaSize.y=e.dynamicCaption.originalPanAreaSize.y):(e.panAreaSize.x=e.dynamicCaption.adjustedPanAreaSize.x,e.panAreaSize.y=e.dynamicCaption.adjustedPanAreaSize.y))}useMobileLayout(){let{mobileLayoutBreakpoint:e}=this.options;return"function"==typeof e?e.call(this):"number"==typeof e&&!!(window.innerWidth<e)}hideCaption(e){if(e.dynamicCaption&&!e.dynamicCaption.hidden){let i=e.dynamicCaption.element;i&&(e.dynamicCaption.hidden=!0,i.classList.add("pswp__dynamic-caption--faded"),e.captionFadeTimeout&&clearTimeout(e.captionFadeTimeout),e.captionFadeTimeout=setTimeout(()=>{i.style.visibility="hidden",delete e.captionFadeTimeout},400))}}setCaptionYOffset(e,i){e.style.transform=`translateY(${i}px)`}showCaption(e){if(e.dynamicCaption&&e.dynamicCaption.hidden){let i=e.dynamicCaption.element;i&&(e.dynamicCaption.hidden=!1,i.style.visibility="visible",clearTimeout(e.captionFadeTimeout),e.captionFadeTimeout=setTimeout(()=>{i.classList.remove("pswp__dynamic-caption--faded"),delete e.captionFadeTimeout},50))}}setCaptionPosition(e,i,t){let n=i<=this.options.horizontalEdgeThreshold;e.classList[n?"add":"remove"]("pswp__dynamic-caption--on-hor-edge"),e.style.left=i+"px",e.style.top=t+"px"}setCaptionWidth(e,i){i?e.style.width=i+"px":e.style.removeProperty("width")}setCaptionType(e,i){let t=e.dataset.pswpCaptionType;i!==t&&(e.classList.add("pswp__dynamic-caption--"+i),e.classList.remove("pswp__dynamic-caption--"+t),e.dataset.pswpCaptionType=i)}updateCaptionPosition(e){if(!e.dynamicCaption||!e.dynamicCaption.type||!e.dynamicCaption.element)return;if("mobile"===e.dynamicCaption.type){this.setCaptionType(e.dynamicCaption.element,e.dynamicCaption.type),e.dynamicCaption.element.style.removeProperty("left"),e.dynamicCaption.element.style.removeProperty("top"),this.setCaptionWidth(e.dynamicCaption.element,!1);return}let i=e.zoomLevels.initial,t=Math.ceil(e.width*i),n=Math.ceil(e.height*i);this.setCaptionType(e.dynamicCaption.element,e.dynamicCaption.type),"aside"===e.dynamicCaption.type?(this.setCaptionPosition(e.dynamicCaption.element,e.bounds.center.x+t,e.bounds.center.y),this.setCaptionWidth(e.dynamicCaption.element,!1)):"below"===e.dynamicCaption.type&&(this.setCaptionPosition(e.dynamicCaption.element,e.bounds.center.x,e.bounds.center.y+n),this.setCaptionWidth(e.dynamicCaption.element,t))}onCalcSlideSize(e){let{slide:i}=e,t,n;if(!i.dynamicCaption){i.dynamicCaption={element:void 0,type:!1,hidden:!1};let a=this.getCaptionHTML(i);if(!a)return;i.dynamicCaption.element=document.createElement("div"),i.dynamicCaption.element.className="pswp__dynamic-caption pswp__hide-on-close",i.dynamicCaption.element.innerHTML=a,this.pswp.dispatch("dynamicCaptionUpdateHTML",{captionElement:i.dynamicCaption.element,slide:i}),i.holderElement.appendChild(i.dynamicCaption.element)}if(!i.dynamicCaption.element)return;this.storeOriginalPanAreaSize(i),i.bounds.update(i.zoomLevels.initial),this.useMobileLayout()?(i.dynamicCaption.type="mobile",n=!0):"auto"===this.options.type?i.bounds.center.x>i.bounds.center.y?i.dynamicCaption.type="aside":i.dynamicCaption.type="below":i.dynamicCaption.type=this.options.type;let o=Math.ceil(i.width*i.zoomLevels.initial),p=Math.ceil(i.height*i.zoomLevels.initial);if(this.setCaptionType(i.dynamicCaption.element,i.dynamicCaption.type),"aside"===i.dynamicCaption.type){this.setCaptionWidth(i.dynamicCaption.element,!1),t=this.measureCaptionSize(i.dynamicCaption.element,e.slide);let s=t.x,d=o+i.bounds.center.x,l=i.panAreaSize.x-d;l<=s&&(i.panAreaSize.x-=s,this.recalculateZoomLevelAndBounds(i))}else if("below"===i.dynamicCaption.type||n){this.setCaptionWidth(i.dynamicCaption.element,n?this.pswp.viewportSize.x:o),t=this.measureCaptionSize(i.dynamicCaption.element,e.slide);let c=t.y;if(this.options.verticallyCenterImage)i.panAreaSize.y-=c,this.recalculateZoomLevelAndBounds(i);else{let m=p+i.bounds.center.y,y=i.panAreaSize.y-m,r=i.panAreaSize.y;if(y<=c){i.panAreaSize.y-=Math.min((c-y)*2,c),this.recalculateZoomLevelAndBounds(i);let C=i.panAreaSize.x*this.options.mobileCaptionOverlapRatio/2;n&&i.bounds.center.x>C&&(i.panAreaSize.y=r,this.recalculateZoomLevelAndBounds(i))}}}this.storeAdjustedPanAreaSize(i),this.updateCaptionPosition(i)}measureCaptionSize(e,i){let t=e.getBoundingClientRect(),n=this.pswp.dispatch("dynamicCaptionMeasureSize",{captionEl:e,slide:i,captionSize:{x:t.width,y:t.height}});return n.captionSize}recalculateZoomLevelAndBounds(e){e.zoomLevels.update(e.width,e.height,e.panAreaSize),e.bounds.update(e.zoomLevels.initial)}storeAdjustedPanAreaSize(e){e.dynamicCaption&&(e.dynamicCaption.adjustedPanAreaSize||(e.dynamicCaption.adjustedPanAreaSize={}),e.dynamicCaption.adjustedPanAreaSize.x=e.panAreaSize.x,e.dynamicCaption.adjustedPanAreaSize.y=e.panAreaSize.y)}storeOriginalPanAreaSize(e){e.dynamicCaption&&(e.dynamicCaption.originalPanAreaSize||(e.dynamicCaption.originalPanAreaSize={}),e.dynamicCaption.originalPanAreaSize.x=e.panAreaSize.x,e.dynamicCaption.originalPanAreaSize.y=e.panAreaSize.y)}getCaptionHTML(e){if("function"==typeof this.options.captionContent)return this.options.captionContent.call(this,e);let i=e.data.element,t="";if(i){let n=i.querySelector(this.options.captionContent);if(n)t=n.innerHTML;else{let a=i.querySelector("img");a&&(t=a.getAttribute("alt"))}}return t}}export default PhotoSwipeDynamicCaption;